- 数据生产层：
  有ETL，数据仓库，自己写的一些日志处理的工具
  （最底层，数据产生层，主要是从日志中获取用户行为数据）
- 数据存储：
  mysql，redis，ES
- 召回层（离线计算结果）：
  - item-base CF
    - 考虑了用户的购买了，购买商品次数，浏览次数
    - itemcf中商品的相似度是根据用户来计算的，在我们的平台中，用户数量是多于商品数量的，在计算商品相似度的时候考虑了流行因素的影响，对于购买用户较多的商品，进行降权处理
    - 加入时间衰减因子（对很久之前购买的商品进行评分衰减）
    - 利用用户购买数据时也加入时间衰减因子，$\frac{1}{1+\alpha |t_{ui}-t_{uj}|}$ 购买时间越近，相似度越高
  - 冷启动推荐结果
    - 根据用户所在的省份，当前季度，是否节假日进行流行度推荐
    - 利用用户特征（经济水平，年采购额，下单次数，登录频次，购买商品数等）进行聚类，聚类之后，根据用户所在的类别，推荐该类别所喜欢的商品
    - 利用一些外部数据，从某些渠道获取一些全国葡萄酒进口数据，分析当年的流行酒款，利用这些分析好的数据作为用户冷启动推荐的依据
    - 商品冷启动
      - 利用商品的属性，计算商品间的相似度，找到和这款新商品相似的商品，然后再获取对这些商品感兴趣的用户再进行推荐。
  - 基于内容推荐（用户商品矩阵和商品特征矩阵相乘，就得到了，用户偏好矩阵，也就得到了每个用户的偏好向量，这个偏好是用户对每一项属性值的偏好，加入说国家这个特征，共有10个属性值，那么把用户对这10个属性值的偏好评分加和，那么就得到了，用户对国家这个特征的偏好。）
    - 获取到用户偏好向量后，就可以用用户偏好向量和商品进行相似度计算，产生推荐结果
  - 矩阵分解
    - 将用户商品矩阵分解成为用户偏好矩阵和商品特征矩阵
      - 开始是利用用户下单数据形成用户商品矩阵，但是因为太稀疏效果不太好，然后开始想办法让矩阵变得更稠密些，于是开始考虑加入浏览数据，也考虑加入一些负评分，当一款商品对用户曝光过，但是用户并没有进入商品详情页，就视为用户对这款商品不感兴趣，从而是负分。
    - 同时得到了用户向量和商品向量，这部分向量也作为特征输入到DeepFM中
  - 基于用户交互行为：利用用户最近产生交互的商品，不同的交互行为有着不同的权重，这个权重用于相似度计算的权重，比如说，下单，权重是1，浏览权重是0.5，找到这些商品的相似商品后（距离度量使用的是加权欧式距离（全重来自模型训练），），按距离排序输出前N个商品。
  - 利用用户搜索数据，分词后，获取用户当前感兴趣的特征，给用户推荐含有这个特征的商品。
- 结果融合&规则过滤
  - 主要是业务规则
  - 添加随机产品 以增加推荐新颖性
- 精排
  - LR
    - 输入特征（用户特征：用户画像，上下文：季节，时间，是否节假日，设备 商品特征：）
    - 特征选择：
      - 方差检验，卡方检验， 递归特征消除等方法进行特征选择
      - 利用决策树进行筛选交叉特征，从根节点到叶节点的一条路径就可以认为是一个交叉特征组合（节假日之前用户喜欢购买一些高档酒，夏季，气泡酒的销量比较好）
      - 通过配置class_weight来解决样本不均衡的问题
  - DeepFM
    - 特征分为两部分一部分是线性部分，一部分是交叉特征部分
    - 交叉特征部分的权重使用的是embedding向量
    - 样本不均衡（正负样本大概是10：1）
      - 采样
        - 按照batch_size对正负样本分成若干子集，每次训练时从正负样本中选择一个子集进行训练
      - 代价敏感学习
        - 提高正样本权值，降低负样本权值
      - 在测试时正负样本是均衡的
    - 优化
      - 降低浮点类型精度，改为16位浮点类型
      - 减小embedding_size
      - 训练完成后 获取所有特征的参数，将小于某个阈值的参数直接置为0
  - 同时考虑库存、毛利等属性

刚才基于内容获取到了用户偏好，那么当为用户形成推荐结果的时候，为用户展示其最感兴趣的特征



缓存机制，装饰器实现：

	存储用户推荐结果